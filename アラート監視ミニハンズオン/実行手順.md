# EC2インスタンスを作る
## VPCの作成
1. VPCのダッシュボードを開く
2. `VPCを作成`をクリック
3. 名前に`test-vpc`と入力
4. IPv4 CIDRに`10.1.0.0/21`を入力
5. `VPCを作成`をクリック

## Public Subnetの作成
1. VPCのダッシュボードから、`サブネット`を開き`サブネットの作成`をクリック
2. VPC IDは、さきほど作成した`test-vpc`を選択
3. サブネット名は`test-subnet`とする
4. `IPv4サブネット CIDRブロック`は、`10.1.0.0/24`とする
5. 入力が終わったら`サブネットの作成`をクリック

## インターネットゲートウエイの設定
1. VPCのダッシュボードから`インターネットゲートウェイ`を開き、`インターネットゲートウェイの作成`をクリック
2. 名前タグは、`test-ig`と入力
3. `インターネットゲートウェイの作成を`クリックします。
4. `VPCへアタッチ`をクリック
5. `使用可能なVPC`にはさきほど作成した`test-vpc`を選択
6. `インターネットゲートウェイのアタッチ`をクリック
7. `ルートテーブルの関連付けの編集`をクリック
8. `ルートを編集`をクリック
9. `ルートを追加`をクリックし、接続先に`0.0.0.0/0`、ターゲットに先ほど作成した`test-ig`を選択
10. `変更を保存`をクリック

## EC2インスタンスの起動
1. EC2のダッシュボードを開き、`EC2の起動`をクリック
2. 名前は、`test-server`と入力
3. AMIは、`Amazon Linux 2023`を選択
4. インスタンスタイプは、無料利用枠の`t2.micro`を選択
5. キーペアは任意のものを選択するか、新しく作成
6. ネットワーク設定について、VPCは`test-vpc`、サブネットは`test-subnet`を選択
7. `パブリックIPの自動割り当て`は`有効化`とする
8. すべて入力したら、`インスタンスの起動`をクリックします。

# SNSの設定
## SNSトピックの作成
1. SNSのダッシュボードを開く
2. 左側のメニューから`トピック`を選択し、`トピックの作成`をクリック
3. タイプは`スタンダード`を選択
4. 名前は`TestTopic`とする
5. `トピックの作成`をクリック

## サブスクリプションの作成
1. `サブスクリプションの作成`をクリックし
2. `トピックARN`は、さきほど程作った`TestTopic`を選択
3. プロトコルは`Eメール`を選択
4. エンドポイントは、`任意のメールアドレス`を指定
5. `サブスクリプションの作成`をクリックします。
6. エンドポイントに指定したメールアドレスに認証メールが届くので、記載のリンクをクリックし、認証を完了させておく

# CloudWatch Alarmの設定
1. CloudWatchのダッシュボードを開く
2. 左側のメニューから`アラーム`をクリックし、`アラームの作成`をクリック
3. `メトリクスの選択`をクリックし
4. メトリクスの中から、インスタンス名が`test-server`で、`CPU utilization`となっているものを選ぶ
5. 統計は`平均値`、期間は`5分`を指定
6. 条件について、しきい値は`静的`を選び、条件として`よりおおきい`を選び、`「…よりも`に`70`を選
7. アラーム状態トリガーの設定は、`アラーム状態`をクリック
8. 「次のSNSトピックに通知を送信」では、さきほど作成した`TestTopic`を選択
9. アラーム名は`CPU-Alarm`と入力
10. `次へ`をクリック
11. プレビュー画面にて`作成`をクリック

# 動作確認
1. `test-server`のEC2インスタンスにログイン
2. 下記コマンドを実行
```bash
sudo yum install -y stress
stress --cpu 1 --timeout 600
```
3. 数分経過すると、CloudWatch AlarmのCPU-Alarmがアラーム状態になり、SNSトピックのサブスクリプションに記載したメールアドレスにアラートメールが送信さることを確認

# リソースの削除

## アラームの削除
1. 作成したCPU-Alarmをチェックし、`アラーム`→`削除`をクリック

## SNSサブスクリプションの削除
2. 該当のサブスクリプションをチェックした状態で、`削除`をクリック

## SNSトピックの削除
3. `TestTopic`を選択した状態で、`削除`をクリック

## EC2インスタンスの削除
4. test-serverをチェックした状態で、`インスタンスの状態`→`インスタンスを終了`をクリック

## インターネットゲートウェイの削除
1. `test-ig`を選択肢、`アクション`→`VPCからデタッチ`をクリック
2. `test-ig`をチェックした状態で`アクション`→`インターネットゲートウェイの削除`をクリック

## サブネットの削除
1. `test-subnet`をチェックした状態で、`アクション`→`サブネットを削除`をクリック

## VPCの削除
1. `test-vpc`がチェックされている状態で、`アクション`→`VPCの削除`をクリック